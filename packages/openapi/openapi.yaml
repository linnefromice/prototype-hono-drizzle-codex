openapi: 3.1.0
info:
  title: Prototype Hono Drizzle API
  version: 0.1.0
servers:
  - url: http://localhost:3000
paths:
  /health:
    get:
      summary: Health check
      responses:
        '200':
          description: Service health status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
  /items:
    get:
      summary: List items
      responses:
        '200':
          description: Items collection
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Item'
    post:
      summary: Create item
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateItemRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Item'
  /conversations:
    get:
      summary: List conversations for a user
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Conversations for the given user
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ConversationDetail'
    post:
      summary: Create a conversation
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConversationRequest'
      responses:
        '201':
          description: Created conversation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationDetail'
  /conversations/{id}:
    get:
      summary: Get a conversation detail
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Conversation detail
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationDetail'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalServerError'
  /conversations/{id}/participants:
    post:
      summary: Add a participant to a conversation
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddParticipantRequest'
      responses:
        '201':
          description: Added participant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Participant'
  /conversations/{id}/leave:
    post:
      summary: Leave a conversation
      description: Mark the authenticated user as having left the conversation
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: User marked as left from conversation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Participant'
        '401':
          description: Unauthorized - not authenticated
        '403':
          description: Forbidden - user is not a participant in this conversation
        '404':
          description: Conversation not found
  /conversations/{id}/messages:
    get:
      summary: List messages in a conversation
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 100
        - name: before
          in: query
          required: false
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Messages collection
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Message'
    post:
      summary: Send message to a conversation
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
      responses:
        '201':
          description: Created message
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Message'
  /messages/{id}:
    delete:
      summary: Delete a message
      description: Soft-delete a message. Only the sender or conversation admin can delete.
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Message successfully deleted
        '403':
          description: Forbidden - user is not authorized to delete this message
        '404':
          description: Message not found
  /messages/{id}/reactions:
    get:
      summary: Get reactions for a message
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of reactions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Reaction'
        '404':
          description: Message not found
    post:
      summary: Add reaction to message
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReactionRequest'
      responses:
        '201':
          description: Reaction added
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reaction'
  /messages/{id}/reactions/{emoji}:
    delete:
      summary: Remove reaction from message
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: emoji
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Reaction removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Reaction'
  /conversations/{id}/read:
    post:
      summary: Update last read message in a conversation
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateConversationReadRequest'
      responses:
        '200':
          description: Updated read position
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateConversationReadResponse'
  /conversations/{id}/unread-count:
    get:
      summary: Get unread count for a conversation
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Unread count for the conversation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnreadCountResponse'
  /messages/{id}/bookmarks:
    post:
      summary: Bookmark a message
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BookmarkRequest'
      responses:
        '201':
          description: Message bookmarked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookmarkResponse'
    delete:
      summary: Remove bookmark from a message
      security:
        - cookieAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Bookmark removed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UnbookmarkResponse'
  /users:
    get:
      summary: List all users (development only)
      description: Get a list of all users. Only available in development mode.
      responses:
        '200':
          description: List of users
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/User'
        '403':
          description: Forbidden - only available in development mode
    post:
      summary: Create user (development only)
      description: Creates a new user. Only available in development mode.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
      responses:
        '201':
          description: Created user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '403':
          description: Forbidden - only available in development mode
  /users/{userId}:
    get:
      summary: Get user by ID
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: User details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          description: User not found
  /bookmarks:
    get:
      summary: List bookmarks for authenticated user
      description: Get all bookmarks for the currently authenticated user
      security:
        - cookieAuth: []
      responses:
        '200':
          description: User bookmarks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BookmarkListItem'
        '401':
          description: Unauthorized - not authenticated
  /users/login:
    post:
      summary: Login user by ID alias
      description: Authenticate and retrieve user information by their unique ID alias
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Bad request - invalid idAlias format
        '404':
          description: User not found
  /api/auth/sign-up/email:
    post:
      summary: Sign up with username and email
      description: Create a new user account with username, email, and password using BetterAuth
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignUpRequest'
      responses:
        '200':
          description: User successfully created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Bad request - validation error or duplicate username/email
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthError'
  /api/auth/sign-in/username:
    post:
      summary: Sign in with username
      description: Authenticate user with username and password
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignInRequest'
      responses:
        '200':
          description: Successfully authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
          headers:
            Set-Cookie:
              schema:
                type: string
                example: better-auth.session_token=<token>; Path=/; HttpOnly
        '401':
          description: Unauthorized - invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthError'
  /api/auth/get-session:
    get:
      summary: Get current session
      description: Retrieve the current authenticated user's session information
      tags:
        - Authentication
      parameters:
        - name: Cookie
          in: header
          required: false
          schema:
            type: string
            example: better-auth.session_token=<token>
      responses:
        '200':
          description: Session information or null if not authenticated
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/SessionResponse'
                  - type: 'null'
  /api/auth/sign-out:
    post:
      summary: Sign out
      description: Invalidate the current session and sign out the user
      tags:
        - Authentication
      parameters:
        - name: Cookie
          in: header
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Successfully signed out
  /api/protected/me:
    get:
      summary: Get authenticated user info
      description: Get current authenticated user's auth information
      tags:
        - Protected
      security:
        - cookieAuth: []
      responses:
        '200':
          description: User auth information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthUserInfo'
        '401':
          description: Unauthorized - not authenticated
  /api/protected/profile:
    get:
      summary: Get user profile
      description: Get current user's complete profile including chat information
      tags:
        - Protected
      security:
        - cookieAuth: []
      responses:
        '200':
          description: User profile with auth and chat information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized - not authenticated
  /api/protected/profile/name:
    put:
      summary: Update profile name
      description: Update user's name in chat profile
      tags:
        - Protected
      security:
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileNameRequest'
      responses:
        '200':
          description: Profile name updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateProfileNameResponse'
        '400':
          description: Bad request - invalid name
        '401':
          description: Unauthorized - not authenticated
  /api/protected/public:
    get:
      summary: Public endpoint with optional auth
      description: Example endpoint that works for both authenticated and guest users
      tags:
        - Protected
      parameters:
        - name: Cookie
          in: header
          required: false
          schema:
            type: string
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicResponse'
components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: better-auth.session_token
  responses:
    BadRequest:
      description: Bad request - Invalid input or validation error
      content:
        application/json:
          schema:
            oneOf:
              - $ref: '#/components/schemas/ErrorResponse'
              - $ref: '#/components/schemas/ValidationErrorResponse'
    Unauthorized:
      description: Unauthorized - Authentication required
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Not found - Resource does not exist
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
  schemas:
    HealthResponse:
      type: object
      properties:
        ok:
          type: boolean
      required:
        - ok
    Item:
      type: object
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        createdAt:
          type: string
          format: date-time
      required:
        - id
        - name
        - createdAt
    CreateItemRequest:
      type: object
      properties:
        name:
          type: string
      required:
        - name
    CreateUserRequest:
      type: object
      properties:
        idAlias:
          type: string
          pattern: '^[a-z0-9][a-z0-9._-]*[a-z0-9]$'
          minLength: 3
          maxLength: 30
          description: 'Unique human-readable identifier. Only lowercase letters, numbers, dots, underscores, and hyphens allowed. No spaces.'
        name:
          type: string
          minLength: 1
        avatarUrl:
          type: string
          nullable: true
      required:
        - idAlias
        - name
    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        idAlias:
          type: string
          pattern: '^[a-z0-9][a-z0-9._-]*[a-z0-9]$'
          minLength: 3
          maxLength: 30
          description: 'Unique human-readable identifier for login and display. Must start and end with lowercase letter or number. Only lowercase letters, numbers, dots, underscores, and hyphens allowed. No spaces.'
        name:
          type: string
        avatarUrl:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
      required:
        - id
        - idAlias
        - name
        - createdAt
    Participant:
      type: object
      properties:
        id:
          type: string
          format: uuid
        conversationId:
          type: string
          format: uuid
        userId:
          type: string
        role:
          type: string
          enum: [member, admin]
        joinedAt:
          type: string
          format: date-time
        leftAt:
          type: string
          format: date-time
          nullable: true
        user:
          $ref: '#/components/schemas/User'
      required:
        - id
        - conversationId
        - userId
        - role
        - joinedAt
        - user
    Conversation:
      type: object
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [direct, group]
        name:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
      required:
        - id
        - type
        - createdAt
    ConversationDetail:
      allOf:
        - $ref: '#/components/schemas/Conversation'
        - type: object
          properties:
            participants:
              type: array
              items:
                $ref: '#/components/schemas/Participant'
          required:
            - participants
    Message:
      type: object
      properties:
        id:
          type: string
          format: uuid
        conversationId:
          type: string
          format: uuid
        senderUserId:
          type: string
          format: uuid
          nullable: true
        type:
          type: string
          enum: [text, system]
        text:
          type: string
          nullable: true
        replyToMessageId:
          type: string
          format: uuid
          nullable: true
        systemEvent:
          type: string
          enum: [join, leave]
          nullable: true
        createdAt:
          type: string
          format: date-time
        reactions:
          type: array
          items:
            $ref: '#/components/schemas/Reaction'
      required:
        - id
        - conversationId
        - type
        - createdAt
        - reactions
    Reaction:
      type: object
      properties:
        id:
          type: string
          format: uuid
        messageId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        emoji:
          type: string
        createdAt:
          type: string
          format: date-time
      required:
        - id
        - messageId
        - userId
        - emoji
        - createdAt
    CreateConversationRequest:
      type: object
      properties:
        type:
          type: string
          enum: [direct, group]
        name:
          type: string
          nullable: true
        participantIds:
          type: array
          items:
            type: string
            format: uuid
          minItems: 1
      required:
        - type
        - participantIds
    AddParticipantRequest:
      type: object
      properties:
        userId:
          type: string
          format: uuid
        role:
          type: string
          enum: [member, admin]
          nullable: true
      required:
        - userId
    SendMessageRequest:
      type: object
      properties:
        text:
          type: string
          nullable: true
        replyToMessageId:
          type: string
          format: uuid
          nullable: true
      description: Send a message to a conversation. The senderUserId is automatically determined from the authenticated session. At least 'text' should be provided for normal messages.
    ReactionRequest:
      type: object
      properties:
        emoji:
          type: string
      required:
        - emoji
      description: Add a reaction to a message. The userId is automatically determined from the authenticated session.
    UpdateConversationReadRequest:
      type: object
      properties:
        lastReadMessageId:
          type: string
          format: uuid
      required:
        - lastReadMessageId
      description: Mark conversation as read up to a specific message. The userId is automatically determined from the authenticated session.
    ConversationRead:
      type: object
      properties:
        id:
          type: string
          format: uuid
        conversationId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        lastReadMessageId:
          type: string
          format: uuid
          nullable: true
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - conversationId
        - userId
        - updatedAt
    UpdateConversationReadResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok]
        read:
          $ref: '#/components/schemas/ConversationRead'
      required:
        - status
        - read
    UnreadCountResponse:
      type: object
      properties:
        unreadCount:
          type: integer
          minimum: 0
      required:
        - unreadCount
    Bookmark:
      type: object
      properties:
        id:
          type: string
          format: uuid
        messageId:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        createdAt:
          type: string
          format: date-time
      required:
        - id
        - messageId
        - userId
        - createdAt
    BookmarkRequest:
      type: object
      properties: {}
      description: Add a bookmark to a message. The userId is automatically determined from the authenticated session. No request body is required.
    BookmarkResponse:
      type: object
      properties:
        status:
          type: string
          enum: [bookmarked]
        bookmark:
          $ref: '#/components/schemas/Bookmark'
      required:
        - status
        - bookmark
    UnbookmarkResponse:
      type: object
      properties:
        status:
          type: string
          enum: [unbookmarked]
      required:
        - status
    BookmarkListItem:
      type: object
      properties:
        messageId:
          type: string
          format: uuid
        conversationId:
          type: string
          format: uuid
        text:
          type: string
          nullable: true
        createdAt:
          type: string
          format: date-time
        messageCreatedAt:
          type: string
          format: date-time
      required:
        - messageId
        - conversationId
        - createdAt
        - messageCreatedAt
    LoginRequest:
      type: object
      properties:
        idAlias:
          type: string
          pattern: '^[a-z0-9][a-z0-9._-]*[a-z0-9]$'
          minLength: 3
          maxLength: 30
      required:
        - idAlias
    SignUpRequest:
      type: object
      properties:
        username:
          type: string
          minLength: 3
          maxLength: 20
          pattern: '^[a-zA-Z0-9_]+$'
          description: 'Username (3-20 characters, alphanumeric and underscore only, case-insensitive)'
        email:
          type: string
          format: email
          description: 'Email address (required)'
        password:
          type: string
          minLength: 8
          description: 'Password (minimum 8 characters)'
        name:
          type: string
          description: 'Display name'
      required:
        - username
        - email
        - password
        - name
    SignInRequest:
      type: object
      properties:
        username:
          type: string
          description: 'Username (case-insensitive)'
        password:
          type: string
      required:
        - username
        - password
    AuthUser:
      type: object
      properties:
        id:
          type: string
          description: 'User ID'
        username:
          type: string
          description: 'Username'
        name:
          type: string
          description: 'Display name'
        email:
          type: string
          format: email
          description: 'Email address'
        emailVerified:
          type: boolean
          description: 'Whether email is verified'
        image:
          type: string
          nullable: true
          description: 'Profile image URL'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required:
        - id
        - username
        - name
        - email
        - emailVerified
        - createdAt
        - updatedAt
    AuthSession:
      type: object
      properties:
        id:
          type: string
          description: 'Session ID'
        expiresAt:
          type: string
          format: date-time
          description: 'Session expiration time'
        userId:
          type: string
          description: 'User ID associated with this session'
        token:
          type: string
          description: 'Session token'
      required:
        - id
        - expiresAt
    AuthResponse:
      type: object
      properties:
        user:
          $ref: '#/components/schemas/AuthUser'
        token:
          type: string
          description: 'Authentication token'
      required:
        - user
    SessionResponse:
      type: object
      properties:
        session:
          $ref: '#/components/schemas/AuthSession'
        user:
          $ref: '#/components/schemas/AuthUser'
      required:
        - session
        - user
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
          description: 'Human-readable error message'
          example: 'Resource not found'
        code:
          type: string
          description: 'Optional error code for programmatic handling'
          example: 'NOT_FOUND'
        details:
          description: 'Optional additional error details'
      required:
        - message
    ValidationErrorResponse:
      type: object
      properties:
        message:
          type: string
          description: 'Human-readable error message'
          example: 'Validation error'
        code:
          type: string
          description: 'Error code'
          example: 'VALIDATION_ERROR'
        details:
          type: array
          description: 'Field-level validation errors'
          items:
            type: object
            properties:
              path:
                type: string
                description: 'Field path that failed validation'
                example: 'email'
              message:
                type: string
                description: 'Validation error message for this field'
                example: 'Email must be a valid email address'
            required:
              - path
              - message
      required:
        - message
        - details
    AuthError:
      description: 'Deprecated: Use ErrorResponse instead'
      allOf:
        - $ref: '#/components/schemas/ErrorResponse'
    AuthUserInfo:
      type: object
      properties:
        user:
          type: object
          properties:
            id:
              type: string
            username:
              type: string
            name:
              type: string
            email:
              type: string
              format: email
            emailVerified:
              type: boolean
          required:
            - id
            - username
            - name
            - email
            - emailVerified
        session:
          type: object
          properties:
            id:
              type: string
            expiresAt:
              type: string
              format: date-time
          required:
            - id
            - expiresAt
      required:
        - user
        - session
    ChatUserInfo:
      type: object
      properties:
        id:
          type: string
          format: uuid
        idAlias:
          type: string
        name:
          type: string
        avatarUrl:
          type: string
          nullable: true
      required:
        - id
        - idAlias
        - name
    UserProfile:
      type: object
      properties:
        auth:
          type: object
          properties:
            id:
              type: string
            username:
              type: string
            name:
              type: string
            email:
              type: string
              format: email
          required:
            - id
            - username
            - name
            - email
        chat:
          allOf:
            - $ref: '#/components/schemas/ChatUserInfo'
            - type: object
              nullable: true
      required:
        - auth
        - chat
    UpdateProfileNameRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          description: 'New name for the user profile'
      required:
        - name
    UpdateProfileNameResponse:
      type: object
      properties:
        success:
          type: boolean
        chatUser:
          $ref: '#/components/schemas/ChatUserInfo'
      required:
        - success
        - chatUser
    PublicResponse:
      type: object
      properties:
        message:
          type: string
        authenticated:
          type: boolean
      required:
        - message
        - authenticated
